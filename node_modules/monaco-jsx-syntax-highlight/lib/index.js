Object.defineProperty(exports, '__esModule', { value: true });

var worker = "/******************************************************************************\r\nCopyright (c) Microsoft Corporation.\r\n\r\nPermission to use, copy, modify, and/or distribute this software for any\r\npurpose with or without fee is hereby granted.\r\n\r\nTHE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH\r\nREGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY\r\nAND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,\r\nINDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM\r\nLOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR\r\nOTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR\r\nPERFORMANCE OF THIS SOFTWARE.\r\n***************************************************************************** */\r\n\r\nvar __assign = function() {\r\n    __assign = Object.assign || function __assign(t) {\r\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\r\n            s = arguments[i];\r\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\r\n        }\r\n        return t;\r\n    };\r\n    return __assign.apply(this, arguments);\r\n};\n\nvar getTypescriptUrl=function(){var t=\"https://cdnjs.cloudflare.com/ajax/libs/typescript/4.6.4/typescript.min.js\";try{return __TYPESCRIPT_CUSTOM_URL__||t}catch(r){return t}};self.importScripts([getTypescriptUrl()]);var Typescript=self.ts;\n\nvar JsxToken={angleBracket:\"jsx-tag-angle-bracket\",attributeKey:\"jsx-tag-attribute-key\",tagName:\"jsx-tag-name\",expressionBraces:\"jsx-expression-braces\",text:\"jsx-text\",orderTokenPrefix:\"jsx-tag-order\"};\n\nvar getRowAndColumn=function(n,o){for(var t=0,e=0;e+o[t]<n;)e+=o[t],t+=1;return {row:t+1,column:n-e}};var getNodeRange=function(n){return \"function\"==typeof n.getStart&&\"function\"==typeof n.getEnd?[n.getStart(),n.getEnd()]:void 0!==n.pos&&void 0!==n.end?[n.pos,n.end]:[0,0]};var calcPosition=function(n,o){var t=getNodeRange(n),e=t[0],r=t[1];return {indexes:[e,r],positions:[getRowAndColumn(e+1,o),getRowAndColumn(r,o)]}};\n\nvar disposeJsxElementOrFragment=function(n){var s=n.node,e=n.lines,t=n.classifications,o=n.config,a=n.context,i=\"\".concat(JsxToken.orderTokenPrefix,\"-\").concat(a.jsxTagOrder);if(a.jsxTagOrder=a.jsxTagOrder+1>o.jsxTagCycle?1:a.jsxTagOrder+1,s.kind===Typescript.SyntaxKind.JsxSelfClosingElement){var r=calcPosition(s,e).positions,c=calcPosition(s.tagName,e).positions;t.push({start:r[0],end:r[0],tokens:[JsxToken.angleBracket,i]}),t.push({start:__assign(__assign({},r[1]),{column:r[1].column-1}),end:r[1],tokens:[JsxToken.angleBracket,i]}),t.push({start:c[0],end:c[1],tokens:[JsxToken.tagName,i]});}else {var p=s.kind===Typescript.SyntaxKind.JsxFragment?s.openingFragment:s.openingElement,g=s.kind===Typescript.SyntaxKind.JsxFragment?s.closingFragment:s.closingElement,l=calcPosition(p,e).positions,k=calcPosition(g,e).positions;if(t.push({start:l[0],end:l[0],tokens:[JsxToken.angleBracket,i]}),t.push({start:l[1],end:l[1],tokens:[JsxToken.angleBracket,i]}),t.push({start:k[0],end:__assign(__assign({},k[0]),{column:k[0].column+1}),tokens:[JsxToken.angleBracket,i]}),t.push({start:k[1],end:k[1],tokens:[JsxToken.angleBracket,i]}),s.kind===Typescript.SyntaxKind.JsxElement){var m=calcPosition(p.tagName,e).positions,x=calcPosition(g.tagName,e).positions;t.push({start:m[0],end:m[1],tokens:[JsxToken.tagName,i]}),t.push({start:x[0],end:x[1],tokens:[JsxToken.tagName,i]});}}};\n\nvar disposeJsxAttributeKey=function(o){var t=o.node,i=o.lines,s=o.classifications,e=calcPosition(t,i).positions;s.push({start:e[0],end:e[1],tokens:[JsxToken.attributeKey]});};\n\nvar disposeJsxExpression=function(s){var o=s.node,e=s.lines,n=s.classifications,i=calcPosition(o,e).positions;n.push({start:i[0],end:i[0],tokens:[JsxToken.expressionBraces]}),n.push({start:i[1],end:i[1],tokens:[JsxToken.expressionBraces]});};\n\nvar disposeJsxText=function(o){var s=o.node,i=o.lines,t=o.classifications,n=calcPosition(s,i).positions;t.push({start:n[0],end:n[1],tokens:[JsxToken.text]});};\n\nvar disposeNode=function(e){var s=e.node,i=e.index;[Typescript.SyntaxKind.JsxFragment,Typescript.SyntaxKind.JsxElement,Typescript.SyntaxKind.JsxSelfClosingElement].includes(s.kind)&&disposeJsxElementOrFragment(e),s.parent&&s.parent.kind===Typescript.SyntaxKind.JsxAttribute&&s.kind===Typescript.SyntaxKind.Identifier&&0===i&&disposeJsxAttributeKey(e),s.kind===Typescript.SyntaxKind.JsxExpression&&disposeJsxExpression(e),s.kind===Typescript.SyntaxKind.JsxText&&disposeJsxText(e);},walkAST=function(e){disposeNode(e);var s=0;Typescript.forEachChild(e.node,(function(i){return walkAST(__assign(__assign({},e),{node:i,index:s++}))}));},withDefaultConfig=function(e){var s=(e||{}).jsxTagCycle;return {jsxTagCycle:void 0===s?3:s}};var analysis=function(e,s,i){try{var t=[],n=Typescript.createSourceFile(e,s,Typescript.ScriptTarget.ES2020,!0),r=s.split(\"\\n\").map((function(e){return e.length+1}));return walkAST({node:n,lines:r,context:{jsxTagOrder:1},classifications:t,config:withDefaultConfig(i),index:0}),t}catch(e){return (null==i?void 0:i.enableConsole)&&console.error(e),[]}};\n\nself.addEventListener(\"message\",(function(s){var a=s.data,e=a.code,i=a.filePath,n=a.version,o=a.config;try{var l=analysis(i,e,o);self.postMessage({classifications:l,version:n,filePath:i});}catch(s){(null==o?void 0:o.enableConsole)&&console.error(s);}}));\n";
var Worker$1 = {
	worker: worker
};

var getWorker = function () { return Worker$1; };

/**
 * 高亮
 */
var MonacoJsxSyntaxHighlight = /** @class */ (function () {
    function MonacoJsxSyntaxHighlight(worker, monaco, config) {
        var _this = this;
        this.createWorkerFromPureString = function (content, config) {
            // URL.createObjectURL
            window.URL = window.URL || window.webkitURL;
            var blob;
            // replace the custom url
            content = content.replace('__TYPESCRIPT_CUSTOM_URL__', (config === null || config === void 0 ? void 0 : config.customTypescriptUrl) ? "'".concat(config === null || config === void 0 ? void 0 : config.customTypescriptUrl, "'") : 'undefined');
            try {
                blob = new Blob([content], { type: 'application/javascript' });
            }
            catch (e) {
                window.BlobBuilder =
                    window.BlobBuilder ||
                        window.WebKitBlobBuilder ||
                        window.MozBlobBuilder;
                blob = new window.BlobBuilder();
                blob.append(content);
                blob = blob.getBlob();
            }
            var worker = new Worker(URL.createObjectURL(blob));
            // free
            URL.revokeObjectURL(blob);
            return worker;
        };
        this.highlighterBuilder = function (context) {
            var editor = context.editor, _a = context.filePath, filePath = _a === void 0 ? editor.getModel().uri.toString() : _a;
            var decorationsRef = { current: [] };
            var disposeMessage = function (event) {
                var _a = event.data, classifications = _a.classifications, version = _a.version, disposeFilePath = _a.filePath;
                requestAnimationFrame(function () {
                    // 确认为本文件，并且为最新版本
                    if (disposeFilePath === filePath && version === editor.getModel().getVersionId()) {
                        var preDecoration = decorationsRef.current;
                        decorationsRef.current = editor.deltaDecorations(preDecoration, classifications.map(function (classification) { return ({
                            range: new _this.monaco.Range(classification.start.row, classification.start.column, classification.end.row, classification.end.column + 1),
                            options: {
                                inlineClassName: classification.tokens.join(' ')
                            }
                        }); }));
                    }
                });
            };
            // 注册监听事件
            _this.worker.addEventListener('message', disposeMessage);
            return {
                highlighter: function (code) {
                    requestAnimationFrame(function () {
                        var disposeCode = code || editor.getModel().getValue();
                        // send message to worker
                        _this.worker.postMessage({
                            code: disposeCode,
                            filePath: filePath,
                            version: editor.getModel().getVersionId()
                        });
                    });
                },
                dispose: function () {
                    _this.worker.removeEventListener('message', disposeMessage);
                }
            };
        };
        this.monaco = monaco;
        if (typeof worker === 'string') {
            this.worker = new Worker(worker);
        }
        else if (worker.worker &&
            typeof worker.worker === 'string') {
            this.worker = this.createWorkerFromPureString(worker.worker, config);
        }
        else {
            this.worker = worker;
        }
    }
    return MonacoJsxSyntaxHighlight;
}());

exports.MonacoJsxSyntaxHighlight = MonacoJsxSyntaxHighlight;
exports.getWorker = getWorker;
